name: Deploy typescript-service-template

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Build
        env:
          POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
        run: |
          docker-compose build

      - name: Execute Tests
        run: |
          docker-compose run --rm dev npm i
          docker-compose run --rm dev npm test

      - name: 'Login via Azure CLI'
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to container registry
        uses: azure/docker-login@v1
        with:
          login-server: jelkand.azurecr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and Push
        run: |
          docker tag typescript-service-template_ci jelkand.azurecr.io/typescript-service-template:${{ github.sha }}
          docker push jelkand.azurecr.io/typescript-service-template:${{ github.sha }}
      # # Set the target AKS cluster.
      # - name: Set target AKS cluster
      #   uses: azure/k8s-actions/aks-set-context@master
      #   with:
      #     creds: '${{ secrets.AZURE_CREDENTIALS }}'
      #     cluster-name: ilmk8s
      #     resource-group: ILM
      # TODO: Move Env Vars to Secrets
      # - uses: azure/k8s-actions/k8s-create-secret@master
      #   with:
      #     container-registry-url: jelkand.azurecr.io
      #     container-registry-username: ${{ secrets.REGISTRY_USERNAME }}
      #     container-registry-password: ${{ secrets.REGISTRY_PASSWORD }}
      #     secret-name: demo-k8s-secret
      # - name: Ship it!
      #   uses: azure/k8s-actions/k8s-deploy@master
      #   with:
      #     manifests: |
      #       manifests/deployment.yml
      #       manifests/service.yml
      #     images: |
      #       jelkand.azurecr.io/typescript-service-template:${{ github.sha }}
      # imagepullsecrets: |
      #   demo-k8s-secret
